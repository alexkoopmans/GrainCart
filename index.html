<!DOCTYPE html>
<html>
<head>
  <title>Grain Cart Logger</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .status { margin-top: 10px; font-weight: bold; }
    .log-row:hover { background: #f9f9f9; }
    .delete-btn { color: red; cursor: pointer; float: right; }
    .flex-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .button-row { display: flex; gap: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Grain Cart Logger</h2>

  <label for="fieldName">Field Name:</label>
  <input type="text" id="fieldName" placeholder="Enter field name">

  <div class="flex-row">
    <label for="autoLogToggle">Auto Log:</label>
    <input type="checkbox" id="autoLogToggle">
  </div>

  <button onclick="connectBLE()">Connect to ESP32</button>
  <div class="status" id="status">Status: Disconnected</div>
  <div class="status" id="weightDisplay">Weight: --</div>
  <div class="status" id="loadStatus"></div>

  <div class="button-row">
    <button onclick="logLoad()">Log Load</button>
    <button onclick="clearAllLogs()">Clear All Logs</button>
  </div>

  <h3>Logged Loads</h3>
  <table id="logTable">
    <tr><th>Weight</th><th>Field</th><th>Time</th><th></th></tr>
  </table>

  <script>
    let logs = JSON.parse(localStorage.getItem("logs") || "[]");
    let currentField = localStorage.getItem("fieldName") || "";
    let autoLogEnabled = false;
    let lastWeights = [];
    let cooldown = false;

    document.getElementById("fieldName").value = currentField;
    document.getElementById("autoLogToggle").checked = autoLogEnabled;
    document.getElementById("fieldName").addEventListener("input", e => {
      currentField = e.target.value;
      localStorage.setItem("fieldName", currentField);
    });
    document.getElementById("autoLogToggle").addEventListener("change", e => {
      autoLogEnabled = e.target.checked;
    });

    function updateLogTable() {
      const table = document.getElementById("logTable");
      table.innerHTML = "<tr><th>Weight</th><th>Field</th><th>Time</th><th></th></tr>";
      logs.forEach((log, i) => {
        const row = table.insertRow();
        row.className = "log-row";
        row.insertCell(0).textContent = log.weight;
        row.insertCell(1).textContent = log.field;
        row.insertCell(2).textContent = log.timestamp;
        const delCell = row.insertCell(3);
        delCell.innerHTML = `<span class="delete-btn" onclick="deleteLog(${i})">üóëÔ∏è</span>`;
      });
    }

    function deleteLog(index) {
      logs.splice(index, 1);
      localStorage.setItem("logs", JSON.stringify(logs));
      updateLogTable();
    }

    function clearAllLogs() {
      if (confirm("Clear all logs?")) {
        logs = [];
        localStorage.removeItem("logs");
        updateLogTable();
      }
    }

    function logLoad(auto = false) {
      const weight = lastWeights[lastWeights.length - 1] || 0;
      const timestamp = new Date().toLocaleString();
      const log = { weight, field: currentField, timestamp };
      logs.push(log);
      localStorage.setItem("logs", JSON.stringify(logs));
      updateLogTable();
      document.getElementById("loadStatus").textContent = auto ? "Auto-logged ‚úÖ" : "Logged ‚úÖ";

      fetch("https://script.google.com/macros/s/AKfycbzXoVKrCk_8g_lURNH4VfFtYJ6Ihw9_9zM_TZKvsDDglcocr-fQJh1U2ZNQ0ZacAWEH/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ weight, field: currentField, timestamp })
      });
    }

    async function connectBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "GrainCartESP32" }],
          optionalServices: ["12345678-1234-1234-1234-123456789abc"]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("12345678-1234-1234-1234-123456789abc");
        const characteristic = await service.getCharacteristic("abcd1234-ab12-cd34-ef56-abcdef123456");

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleWeightUpdate);
        document.getElementById("status").textContent = "Status: Connected";
      } catch (err) {
        console.error("BLE Connection Error:", err);
        document.getElementById("status").textContent = "Status: Failed to connect - " + err.message;
      }
    }

function handleWeightUpdate(event) {
  const value = event.target.value;
  const decoder = new TextDecoder('utf-8');
  const weightStr = decoder.decode(value);
  
  // Show the raw diagnostic message
  document.getElementById("weightDisplay").textContent = `Weight: ${weightStr}`;
  console.log("Received:", weightStr);
  
  // Try to parse if it's a number
  const weight = parseInt(weightStr);
  if (!isNaN(weight)) {
    lastWeights.push(weight);
    if (lastWeights.length > 10) lastWeights.shift();
  }

  if (!autoLogEnabled || cooldown) return;

  const recentChange = lastWeights[lastWeights.length - 1] - lastWeights[0];
  const fluctuation = Math.max(...lastWeights) - Math.min(...lastWeights);

  if (recentChange >= 500) {
    document.getElementById("loadStatus").textContent = "Loading‚Ä¶ üì¶";
  }

  if (fluctuation < 50 && recentChange >= 500) {
    document.getElementById("loadStatus").textContent = "Stable ‚Äî Logging soon‚Ä¶";
    cooldown = true;
    setTimeout(() => { logLoad(true); cooldown = false; }, 2000);
  }
}

    updateLogTable();
  </script>
</body>
</html>



