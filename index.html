<!DOCTYPE html>
<html>
<head>
  <title>Grain Cart Logger</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    .status { margin-top: 10px; font-weight: bold; }
    .log-row:hover { background: #f9f9f9; }
    .delete-btn { color: red; cursor: pointer; float: right; }
    .flex-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    .button-row { display: flex; gap: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Grain Cart Logger</h2>

  <label for="fieldName">Field Name:</label>
  <input type="text" id="fieldName" placeholder="Enter field name">

  <div class="flex-row">
    <label for="autoLogToggle">Auto Log:</label>
    <input type="checkbox" id="autoLogToggle">
  </div>

  <button onclick="connectBLE()">Connect to ESP32</button>
  <div class="status" id="status">Status: Disconnected</div>
  <div class="status" id="weightDisplay">Weight: --</div>
  <div class="status" id="loadStatus"></div>

  <div class="button-row">
    <button onclick="logLoad()">Log Load</button>
    <button onclick="clearAllLogs()">Clear All Logs</button>
  </div>

  <h3>Logged Loads</h3>
  <table id="logTable">
    <tr><th>Weight</th><th>Field</th><th>Time</th><th></th></tr>
  </table>

  <script>
    let logs = JSON.parse(localStorage.getItem("logs") || "[]");
    let currentField = localStorage.getItem("fieldName") || "";
    let autoLogEnabled = false;
    let weightHistory = []; // Stores {weight, timestamp}
    let loadingStartWeight = null;
    let loadingStartTime = null;
    let isCurrentlyLoading = false;
    let cooldown = false;

    document.getElementById("fieldName").value = currentField;
    document.getElementById("autoLogToggle").checked = autoLogEnabled;
    document.getElementById("fieldName").addEventListener("input", e => {
      currentField = e.target.value;
      localStorage.setItem("fieldName", currentField);
    });
    document.getElementById("autoLogToggle").addEventListener("change", e => {
      autoLogEnabled = e.target.checked;
      // Reset state when toggling
      if (autoLogEnabled) {
        weightHistory = [];
        loadingStartWeight = null;
        loadingStartTime = null;
        isCurrentlyLoading = false;
        document.getElementById("loadStatus").textContent = "";
      }
    });

    function updateLogTable() {
      const table = document.getElementById("logTable");
      table.innerHTML = "<tr><th>Weight</th><th>Field</th><th>Time</th><th></th></tr>";
      logs.forEach((log, i) => {
        const row = table.insertRow();
        row.className = "log-row";
        row.insertCell(0).textContent = log.weight;
        row.insertCell(1).textContent = log.field;
        row.insertCell(2).textContent = log.timestamp;
        const delCell = row.insertCell(3);
        delCell.innerHTML = `<span class="delete-btn" onclick="deleteLog(${i})">üóëÔ∏è</span>`;
      });
    }

    function deleteLog(index) {
      logs.splice(index, 1);
      localStorage.setItem("logs", JSON.stringify(logs));
      updateLogTable();
    }

    function clearAllLogs() {
      if (confirm("Clear all logs?")) {
        logs = [];
        localStorage.removeItem("logs");
        updateLogTable();
      }
    }

    function logLoad(auto = false) {
      const weight = weightHistory[weightHistory.length - 1]?.weight || 0;
      const timestamp = new Date().toLocaleString();
      const log = { weight, field: currentField, timestamp };
      logs.push(log);
      localStorage.setItem("logs", JSON.stringify(logs));
      updateLogTable();
      document.getElementById("loadStatus").textContent = auto ? "Auto-logged ‚úÖ" : "Logged ‚úÖ";

      fetch("https://script.google.com/macros/s/AKfycbzXoVKrCk_8g_lURNH4VfFtYJ6Ihw9_9zM_TZKvsDDglcocr-fQJh1U2ZNQ0ZacAWEH/exec", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ weight, field: currentField, timestamp })
      });
    }

    async function connectBLE() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "GrainCartESP32" }],
          optionalServices: ["12345678-1234-1234-1234-123456789abc"]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("12345678-1234-1234-1234-123456789abc");
        const characteristic = await service.getCharacteristic("abcd1234-ab12-cd34-ef56-abcdef123456");

        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", handleWeightUpdate);
        document.getElementById("status").textContent = "Status: Connected";
      } catch (err) {
        document.getElementById("status").textContent = "Status: Failed to connect";
      }
    }

    function handleWeightUpdate(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const weightStr = decoder.decode(value);
      const weight = parseInt(weightStr);
      
      if (isNaN(weight)) {
        // Display diagnostic messages if not a number
        document.getElementById("weightDisplay").textContent = `Weight: ${weightStr}`;
        return;
      }

      document.getElementById("weightDisplay").textContent = `Weight: ${weight} lbs`;

      const now = Date.now();
      
      // Add to history with timestamp
      weightHistory.push({ weight, timestamp: now });
      
      // Keep only last 30 seconds of data
      weightHistory = weightHistory.filter(entry => now - entry.timestamp < 30000);

      if (!autoLogEnabled || cooldown) return;

      // Get weights from different time windows
      const weights3secAgo = weightHistory.filter(e => now - e.timestamp >= 3000);
      const weights25secAgo = weightHistory.filter(e => now - e.timestamp >= 25000);
      const weights10secAgo = weightHistory.filter(e => now - e.timestamp >= 10000);

      // DETECT LOADING START
      if (!isCurrentlyLoading && weights3secAgo.length > 0 && weights25secAgo.length > 0) {
        const weight3secAgo = weights3secAgo[0].weight;
        const weight25secAgo = weights25secAgo[0].weight;
        const change3sec = weight - weight3secAgo;
        const change25sec = weight - weight25secAgo;

        // Must gain 2000+ lbs in 25 seconds, but NOT within 3 seconds (to avoid zero-out trigger)
        if (change25sec >= 2000 && change3sec < 2000) {
          isCurrentlyLoading = true;
          loadingStartWeight = weight25secAgo;
          loadingStartTime = now;
          document.getElementById("loadStatus").textContent = "Loading detected... üì¶";
        }
      }

      // DETECT LOADING COMPLETE (stable weight)
      if (isCurrentlyLoading && weights10secAgo.length > 0) {
        const recentWeights = weightHistory.filter(e => now - e.timestamp <= 10000).map(e => e.weight);
        const maxWeight = Math.max(...recentWeights);
        const minWeight = Math.min(...recentWeights);
        const fluctuation = maxWeight - minWeight;

        // Stable if weight range is within 500 lbs over 10 seconds
        if (fluctuation <= 500) {
          document.getElementById("loadStatus").textContent = "Stable ‚Äî Logging soon‚Ä¶";
          cooldown = true;
          isCurrentlyLoading = false;
          loadingStartWeight = null;
          loadingStartTime = null;
          
          setTimeout(() => { 
            logLoad(true); 
            cooldown = false; 
          }, 2000);
        } else {
          // Still loading, show current gain
          const currentGain = weight - loadingStartWeight;
          document.getElementById("loadStatus").textContent = `Loading... +${currentGain} lbs üì¶`;
        }
      }
    }

    updateLogTable();
  </script>
</body>
</html>
